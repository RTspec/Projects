<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hostel Management - Fees</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Manage Fees</h1>
    <div class="user-info">
      <a href="/login.html" class="logout-btn">Logout</a>
    </div>
  </header>

  <nav>
    <a href="/dashboard.html">Dashboard</a>
    <a href="/students.html">Students</a>
    <a href="/rooms.html">Rooms</a>
    <a href="/fees.html" class="active">Fees</a>
  </nav>

  <main>
    <div class="form-card">
      <h2>Record Fee Payment</h2>
      <div id="message" class="message"></div>
      <form id="feeForm">
        <select id="student_id" required>
          <option value="">Select Student</option>
        </select>
        <input type="number" id="amount" placeholder="Amount (₹)" min="1" required>
        <select id="payment_type" required>
          <option value="">Select Payment Type</option>
          <option value="rent">Monthly Rent</option>
          <option value="deposit">Security Deposit</option>
          <option value="maintenance">Maintenance</option>
        </select>
        <button type="submit">Record Payment</button>
      </form>
    </div>

    <div class="list-card">
      <h2>Payment Records</h2>
      <div class="filter-section">
        <label>Filter by Status:</label>
        <select id="statusFilter" onchange="filterPayments()">
          <option value="all">All Payments</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
        </select>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Roll Number</th>
              <th>Amount</th>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="feeTable">
            <tr>
              <td colspan="7" class="loading">Loading payment records...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="summary">
        <p><strong>Total Pending:</strong> <span id="totalPending">₹0</span></p>
        <p><strong>Total Collected:</strong> <span id="totalCollected">₹0</span></p>
      </div>
    </div>
  </main>

  <script>
    let allPayments = [];

    // Load students for dropdown
    async function loadStudents() {
      try {
        const response = await fetch('/api/students');
        const students = await response.json();
        
        const select = document.getElementById('student_id');
        select.innerHTML = '<option value="">Select Student</option>';
        
        students.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.name} (${student.roll_number})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    // Load payments
    async function loadPayments() {
      try {
        const response = await fetch('/api/payments');
        allPayments = await response.json();
        
        filterPayments();
        updateSummary();
      } catch (error) {
        console.error('Error loading payments:', error);
        document.getElementById('feeTable').innerHTML = 
          '<tr><td colspan="7" class="error">Error loading payments</td></tr>';
      }
    }

    // Filter payments
    function filterPayments() {
      const filter = document.getElementById('statusFilter').value;
      const filtered = filter === 'all' ? allPayments : 
                      allPayments.filter(p => p.status === filter);
      
      const tbody = document.getElementById('feeTable');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No payment records found</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(payment => {
        const statusClass = payment.status === 'completed' ? 'status-paid' : 
                           payment.status === 'pending' ? 'status-pending' : 'status-failed';
        
        return `
          <tr>
            <td>${payment.student_name || 'N/A'}</td>
            <td>${payment.roll_number || 'N/A'}</td>
            <td>₹${payment.amount}</td>
            <td>${formatPaymentType(payment.payment_type)}</td>
            <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
            <td>
              <select onchange="updatePaymentStatus(${payment.id}, this.value)" class="${statusClass}">
                <option value="pending" ${payment.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="completed" ${payment.status === 'completed' ? 'selected' : ''}>Completed</option>
                <option value="failed" ${payment.status === 'failed' ? 'selected' : ''}>Failed</option>
              </select>
            </td>
            <td>
              <button onclick="deletePayment(${payment.id})" class="delete-btn">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Format payment type
    function formatPaymentType(type) {
      const types = {
        rent: 'Monthly Rent',
        deposit: 'Security Deposit',
        maintenance: 'Maintenance'
      };
      return types[type] || type;
    }

    // Update summary
    function updateSummary() {
      const pending = allPayments
        .filter(p => p.status === 'pending')
        .reduce((sum, p) => sum + parseFloat(p.amount), 0);
      
      const collected = allPayments
        .filter(p => p.status === 'completed')
        .reduce((sum, p) => sum + parseFloat(p.amount), 0);
      
      document.getElementById('totalPending').textContent = '₹' + pending.toFixed(2);
      document.getElementById('totalCollected').textContent = '₹' + collected.toFixed(2);
    }

    // Add payment
    document.getElementById('feeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        student_id: parseInt(document.getElementById('student_id').value),
        amount: parseFloat(document.getElementById('amount').value),
        payment_type: document.getElementById('payment_type').value
      };
      
      try {
        const response = await fetch('/api/payments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        const messageDiv = document.getElementById('message');
        
        if (response.ok) {
          messageDiv.className = 'message success';
          messageDiv.textContent = 'Payment recorded successfully!';
          document.getElementById('feeForm').reset();
          loadPayments();
        } else {
          messageDiv.className = 'message error';
          messageDiv.textContent = result.error || 'Failed to record payment';
        }
        
        setTimeout(() => messageDiv.textContent = '', 3000);
      } catch (error) {
        console.error('Error recording payment:', error);
        document.getElementById('message').className = 'message error';
        document.getElementById('message').textContent = 'Network error. Please try again.';
      }
    });

    // Update payment status
    async function updatePaymentStatus(id, status) {
      try {
        const response = await fetch(`/api/payments/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          loadPayments();
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to update payment status');
          loadPayments();
        }
      } catch (error) {
        console.error('Error updating payment status:', error);
        alert('Network error. Please try again.');
      }
    }

    // Delete payment
    async function deletePayment(id) {
      if (!confirm('Are you sure you want to delete this payment record?')) return;
      
      try {
        const response = await fetch(`/api/payments/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadPayments();
          alert('Payment deleted successfully!');
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to delete payment');
        }
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Network error. Please try again.');
      }
    }

    // Initialize
    loadStudents();
    loadPayments();
  </script>
</body>
</html>