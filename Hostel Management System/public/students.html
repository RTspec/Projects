<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hostel Management - Students</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Manage Students</h1>
    <div class="user-info">
      <a href="/login.html" class="logout-btn">Logout</a>
    </div>
  </header>

  <nav>
    <a href="/dashboard.html">Dashboard</a>
    <a href="/students.html" class="active">Students</a>
    <a href="/rooms.html">Rooms</a>
    <a href="/fees.html">Fees</a>
  </nav>

  <main>
    <div class="form-card">
      <h2>Add New Student</h2>
      <div id="message" class="message"></div>
      <form id="studentForm">
        <input type="text" id="name" placeholder="Student Name" required>
        <input type="email" id="email" placeholder="Email Address" required>
        <input type="text" id="roll_number" placeholder="Roll Number" required>
        <input type="tel" id="phone" placeholder="Phone Number">
        <select id="room_number" required>
          <option value="">Select Room</option>
        </select>
        <button type="submit">Add Student</button>
      </form>
    </div>

    <div class="list-card">
      <h2>Student List</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Roll Number</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Room</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="studentTable">
            <tr>
              <td colspan="6" class="loading">Loading students...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Load available rooms
    async function loadRooms() {
      try {
        const response = await fetch('/api/rooms');
        const rooms = await response.json();
        
        const select = document.getElementById('room_number');
        select.innerHTML = '<option value="">Select Room</option>';
        
        rooms.forEach(room => {
          if (room.occupied < room.capacity && room.status === 'available') {
            const option = document.createElement('option');
            option.value = room.room_number;
            option.textContent = `${room.room_number} (${room.occupied}/${room.capacity})`;
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error('Error loading rooms:', error);
      }
    }

    // Load students
    async function loadStudents() {
      try {
        const response = await fetch('/api/students');
        const students = await response.json();
        
        const tbody = document.getElementById('studentTable');
        
        if (students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="no-data">No students found</td></tr>';
          return;
        }
        
        tbody.innerHTML = students.map(student => `
          <tr>
            <td>${student.name}</td>
            <td>${student.roll_number}</td>
            <td>${student.email}</td>
            <td>${student.phone || 'N/A'}</td>
            <td>${student.room_number}</td>
            <td>
              <button onclick="deleteStudent(${student.id})" class="delete-btn">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('studentTable').innerHTML = 
          '<tr><td colspan="6" class="error">Error loading students</td></tr>';
      }
    }

    // Add student
    document.getElementById('studentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        roll_number: document.getElementById('roll_number').value,
        phone: document.getElementById('phone').value,
        room_number: document.getElementById('room_number').value
      };
      
      try {
        const response = await fetch('/api/students', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        const messageDiv = document.getElementById('message');
        
        if (response.ok) {
          messageDiv.className = 'message success';
          messageDiv.textContent = 'Student added successfully!';
          document.getElementById('studentForm').reset();
          loadStudents();
          loadRooms();
        } else {
          messageDiv.className = 'message error';
          messageDiv.textContent = result.error || 'Failed to add student';
        }
        
        setTimeout(() => messageDiv.textContent = '', 3000);
      } catch (error) {
        console.error('Error adding student:', error);
        document.getElementById('message').className = 'message error';
        document.getElementById('message').textContent = 'Network error. Please try again.';
      }
    });

    // Delete student
    async function deleteStudent(id) {
      if (!confirm('Are you sure you want to delete this student?')) return;
      
      try {
        const response = await fetch(`/api/students/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadStudents();
          loadRooms();
          alert('Student deleted successfully!');
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to delete student');
        }
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Network error. Please try again.');
      }
    }

    // Initialize
    loadRooms();
    loadStudents();
  </script>
</body>
</html>