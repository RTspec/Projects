<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hostel Management - Rooms</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Manage Rooms</h1>
    <div class="user-info">
      <a href="/login.html" class="logout-btn">Logout</a>
    </div>
  </header>

  <nav>
    <a href="/dashboard.html">Dashboard</a>
    <a href="/students.html">Students</a>
    <a href="/rooms.html" class="active">Rooms</a>
    <a href="/fees.html">Fees</a>
  </nav>

  <main>
    <div class="form-card">
      <h2>Add New Room</h2>
      <div id="message" class="message"></div>
      <form id="roomForm">
        <input type="text" id="room_number" placeholder="Room Number (e.g., 101, A-201)" required>
        <input type="number" id="capacity" placeholder="Capacity" min="1" max="10" required>
        <button type="submit">Add Room</button>
      </form>
    </div>

    <div class="list-card">
      <h2>Room List</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Room Number</th>
              <th>Capacity</th>
              <th>Occupied</th>
              <th>Available</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="roomTable">
            <tr>
              <td colspan="6" class="loading">Loading rooms...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Load rooms
    async function loadRooms() {
      try {
        const response = await fetch('/api/rooms');
        const rooms = await response.json();
        
        const tbody = document.getElementById('roomTable');
        
        if (rooms.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="no-data">No rooms found</td></tr>';
          return;
        }
        
        tbody.innerHTML = rooms.map(room => {
          const available = room.capacity - room.occupied;
          const statusClass = room.status === 'available' ? 'status-available' : 
                             room.status === 'maintenance' ? 'status-maintenance' : 'status-full';
          
          return `
            <tr>
              <td><strong>${room.room_number}</strong></td>
              <td>${room.capacity}</td>
              <td>${room.occupied}</td>
              <td>${available}</td>
              <td>
                <select onchange="updateRoomStatus(${room.id}, this.value)" class="${statusClass}">
                  <option value="available" ${room.status === 'available' ? 'selected' : ''}>Available</option>
                  <option value="full" ${room.status === 'full' ? 'selected' : ''}>Full</option>
                  <option value="maintenance" ${room.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                </select>
              </td>
              <td>
                <button onclick="deleteRoom(${room.id})" class="delete-btn">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading rooms:', error);
        document.getElementById('roomTable').innerHTML = 
          '<tr><td colspan="6" class="error">Error loading rooms</td></tr>';
      }
    }

    // Add room
    document.getElementById('roomForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        room_number: document.getElementById('room_number').value.trim(),
        capacity: parseInt(document.getElementById('capacity').value)
      };
      
      try {
        const response = await fetch('/api/rooms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        const messageDiv = document.getElementById('message');
        
        if (response.ok) {
          messageDiv.className = 'message success';
          messageDiv.textContent = 'Room added successfully!';
          document.getElementById('roomForm').reset();
          loadRooms();
        } else {
          messageDiv.className = 'message error';
          messageDiv.textContent = result.error || 'Failed to add room';
        }
        
        setTimeout(() => messageDiv.textContent = '', 3000);
      } catch (error) {
        console.error('Error adding room:', error);
        document.getElementById('message').className = 'message error';
        document.getElementById('message').textContent = 'Network error. Please try again.';
      }
    });

    // Update room status
    async function updateRoomStatus(id, status) {
      try {
        const response = await fetch(`/api/rooms/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          loadRooms();
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to update room status');
          loadRooms();
        }
      } catch (error) {
        console.error('Error updating room status:', error);
        alert('Network error. Please try again.');
      }
    }

    // Delete room
    async function deleteRoom(id) {
      if (!confirm('Are you sure you want to delete this room? This action cannot be undone.')) return;
      
      try {
        const response = await fetch(`/api/rooms/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadRooms();
          alert('Room deleted successfully!');
        } else {
          const result = await response.json();
          alert(result.error || 'Failed to delete room');
        }
      } catch (error) {
        console.error('Error deleting room:', error);
        alert('Network error. Please try again.');
      }
    }

    // Initialize
    loadRooms();
  </script>
</body>
</html>